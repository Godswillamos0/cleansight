<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanSight</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active {
      @apply border-b-4 border-green-500 font-semibold text-green-600;
    }
    body {
      font-family: 'Manrope', sans-serif;
      background-color: #f5fff9;
    }
    .animate-name {
      animation: fadeInSlideUp 1.2s ease-out both;
    }
    @keyframes fadeInSlideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .bg-primary { background-color: #0f5132; }
    .text-primary { color: #0f5132; }
    .border-primary { border-color: #0f5132; }
  </style>
</head>
<body class="bg-[#f0f3f4] min-h-screen text-gray-800">

<!-- Header -->
<header class="flex justify-between items-center px-4 py-3 md:px-6 border-b border-primary bg-white shadow-sm">
  <div class="flex items-center gap-2 animate-name">
    <svg class="w-6 h-6 text-primary" viewBox="0 0 48 48" fill="currentColor">
      <path d="M24 4C25.78 14.22 33.78 22.22 44 24C33.78 25.78 25.78 33.78 24 44C22.22 33.78 14.22 25.78 4 24C14.22 22.22 22.22 14.22 24 4Z"/>
    </svg>
    <h1 class="text-xl font-extrabold text-primary tracking-wide">CleanSight</h1>
  </div>
  <div class="flex items-center gap-4">
    <button class="relative">
      <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M15 17h5l-1.4-1.4C18.8 14.8 18 13.4 18 12V9a6 6 0 10-12 0v3c0 1.4-.8 2.8-1.6 3.6L3 17h5m4 0v1a2 2 0 104 0v-1m-4 0h4"></path>
      </svg>
      <span class="absolute top-0 right-0 block w-2 h-2 bg-red-500 rounded-full ring-2 ring-white"></span>
    </button>
    <img id="profileImage" src="https://via.placeholder.com/50" class="w-9 h-9 rounded-full object-cover" alt="User profile" />
  </div>
</header>

<!-- Title -->
<header class="text-center py-6 bg-white shadow">
  <h1 id="nunsiTitle" class="text-4xl font-bold text-green-600 transition duration-700 ease-in-out">Loading...</h1>
</header>

<!-- Tabs -->
<main class="p-4 max-w-md mx-auto">
  <div class="flex justify-center mb-6">
    <button id="beforeTab" class="px-4 py-2 border-b-4 text-sm tab-active" onclick="switchTab('before')">Before</button>
    <button id="afterTab" class="px-4 py-2 border-b-4 text-sm text-gray-600" onclick="switchTab('after')">After</button>
  </div>

  <!-- BEFORE SECTION -->
  <section id="beforeSection">
    <div class="space-y-4">
      <input type="file" accept="image/*" class="w-full" id="beforeUpload" />
      <p class="text-xs text-gray-500">Upload a photo of the area before cleaning.</p>
    </div>
  </section>

  <!-- AFTER SECTION -->
  <section id="afterSection" class="hidden">
    <div class="space-y-4">
      <video id="video" autoplay class="w-full rounded-lg shadow"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <img id="capturedImage" alt="Captured" class="hidden rounded-lg" />
      <div class="flex justify-between">
        <button onclick="startCamera()" class="bg-green-500 text-white px-4 py-2 rounded shadow">Start Camera</button>
        <button onclick="captureImage()" class="bg-green-600 text-white px-4 py-2 rounded shadow">Capture</button>
      </div>
      <p class="text-xs text-gray-500">Capture the area after you've cleaned it.</p>
    </div>
  </section>

  <!-- Verify -->
  <!-- Verify -->
<div class="mt-6">
  <button id="verifyBtn" onclick="verifyCleanup()" 
    class="bg-green-700 hover:bg-green-800 w-full py-3 text-white font-bold rounded shadow flex items-center justify-center gap-2">
    <span id="verifyText">Verify Cleanup</span>
    <svg id="loadingIcon" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
  </button>
</div>

</main>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const capturedImage = document.getElementById('capturedImage');

// Switch between tabs
function switchTab(tab) {
  document.getElementById('beforeSection').classList.toggle('hidden', tab !== 'before');
  document.getElementById('afterSection').classList.toggle('hidden', tab !== 'after');
  document.getElementById('beforeTab').classList.toggle('tab-active', tab === 'before');
  document.getElementById('afterTab').classList.toggle('tab-active', tab === 'after');
}

// Camera functions
function startCamera() {
  navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: { exact: "environment" } // forces the back camera
    }
  })
  .then(stream => {
    video.srcObject = stream;
  })
  .catch(err => {
    console.error('Camera error:', err);
  });
}


function captureImage() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const dataUrl = canvas.toDataURL('image/png');
  capturedImage.src = dataUrl;
  capturedImage.classList.remove('hidden');
}

// Fetch user data
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("Not logged in!");
    window.location.href = "/login.html";
    return;
  }

  fetch("https://amosgodswill00-cleansightapp.hf.space/user/", {
    method: "GET",
    headers: { "Authorization": `Bearer ${token}` }
  })
    .then(res => res.json())
    .then(user => {
      document.getElementById("nunsiTitle").textContent = user.username;
      if (user.profile_picture) {
        document.getElementById("profileImage").src = user.profile_picture;
      }
    })
    .catch(err => console.error(err));
});

// Verify Cleanup
async function verifyCleanup() {
  const verifyBtn = document.getElementById("verifyBtn");
  const verifyText = document.getElementById("verifyText");
  const loadingIcon = document.getElementById("loadingIcon");

  const beforeUploaded = document.getElementById('beforeUpload').files[0];
  const capturedAfter = capturedImage.src;

  if (!beforeUploaded || !capturedAfter) {
    alert('Please upload the "before" and capture the "after" images.');
    return;
  }

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Not logged in!");
    return;
  }

  // Disable button + show loader
  verifyBtn.disabled = true;
  verifyBtn.classList.add("opacity-70", "cursor-not-allowed");
  verifyText.textContent = "Verifying...";
  loadingIcon.classList.remove("hidden");

  try {
    const afterBlob = await fetch(capturedAfter).then(res => res.blob());
    const formData = new FormData();
    formData.append("pre_image", beforeUploaded);
    formData.append("post_image", afterBlob, "after.png");

    const res = await fetch("https://amosgodswill00-cleansightapp.hf.space/ai/evaluate-cleanliness", {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    const data = await res.json();
    showCongratsPopup(data.total_cleanliness_score, data.tokens_earned);
  } catch (err) {
    console.error(err);
    alert("Error during verification");
  } finally {
    // Re-enable button + hide loader
    verifyBtn.disabled = false;
    verifyBtn.classList.remove("opacity-70", "cursor-not-allowed");
    verifyText.textContent = "Verify Cleanup";
    loadingIcon.classList.add("hidden");
  }
}


// Popup
function showCongratsPopup(score, tokens) {
  const popup = document.createElement("div");
  popup.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
  popup.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm text-center animate-scaleIn">
      <h2 class="text-2xl font-bold text-green-600 mb-4">ðŸŽ‰ Awesome!</h2>
      <p class="text-gray-700">You scored <span class="font-bold">${score}</span> and earned <span class="font-bold">${tokens}</span> tokens!</p>
      <button class="mt-4 bg-green-600 text-white px-4 py-2 rounded" onclick="this.closest('.fixed').remove()">OK</button>
    </div>
  `;
  document.body.appendChild(popup);
}

// Animation for popup
const style = document.createElement("style");
style.innerHTML = `
  @keyframes scaleIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .animate-scaleIn {
    animation: scaleIn 0.3s ease-out;
  }
`;
document.head.appendChild(style);
</script>

</body>
</html>


